#!/bin/sh

# Check branch naming convention
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

# Skip check for main branch
if [ "$BRANCH_NAME" != "main" ]; then
  # Pattern: (feature|fix|hotfix|docs|chore)/description
  if ! echo "$BRANCH_NAME" | grep -qE "^(feature|fix|hotfix|docs|chore)/[a-z0-9][a-z0-9-]*$"; then
    echo ""
    echo "❌ Branch name '$BRANCH_NAME' doesn't follow naming convention"
    echo ""
    echo "Branch names must match: (feature|fix|hotfix|docs|chore)/description"
    echo ""
    echo "Examples:"
    echo "  ✅ feature/add-dark-mode"
    echo "  ✅ fix/audit-bug"
    echo "  ✅ hotfix/critical-security-fix"
    echo "  ✅ docs/update-readme"
    echo "  ✅ chore/update-dependencies"
    echo ""
    echo "  ❌ add-dark-mode (missing type prefix)"
    echo "  ❌ feature/Add-Dark-Mode (must be lowercase)"
    echo "  ❌ feature/add_dark_mode (use hyphens, not underscores)"
    echo ""
    exit 1
  fi
  echo "✅ Branch name '$BRANCH_NAME' follows naming convention"
fi

# Run cm code audit first
echo "Running cm code audit..."
cm code audit || exit 1

# Run cm code check
# Note: This may show npm audit warnings for moderate severity vulnerabilities
# that require breaking changes to fix. We accept these as known issues.
echo "Running cm code check..."
if ! cm code check 2>&1 | tee /tmp/cm-code-check-output.txt; then
  # Check if the only failures are npm audit moderate severity warnings
  if grep -q "✗ npmaudit:" /tmp/cm-code-check-output.txt && \
     ! grep -qE "✗ (ESLint|Prettier|TypeScript|Knip|gitleaks|Tests|Naming):" /tmp/cm-code-check-output.txt; then
    echo ""
    echo "Note: Only npm audit warnings remain (moderate severity, requires breaking vitest upgrade)."
    echo "Proceeding with push..."
  else
    echo ""
    echo "cm code check failed with errors. Please fix before pushing."
    exit 1
  fi
fi

# Run cm code check for dashboard if it has a check.toml
if [ -f "dashboard/check.toml" ]; then
  echo "Running cm code check for dashboard..."
  (cd dashboard && cm code check) || exit 1
fi
