name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  check-branch-name:
    name: Branch Naming
    runs-on: ubuntu-latest
    steps:
      - name: Check branch naming convention
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Checking branch: $BRANCH_NAME"

          # Pattern: <type>/<issue-number>/<description>
          # Issue number is required to link work to GitHub issues
          PATTERN="^(feature|fix|hotfix|docs)/([0-9]+)/[a-z0-9-]+$"

          if [[ "$BRANCH_NAME" =~ $PATTERN ]]; then
            ISSUE_NUM="${BASH_REMATCH[2]}"
            echo "✅ Branch name '$BRANCH_NAME' follows naming convention"
            echo "   Linked to issue: #$ISSUE_NUM"
          else
            echo "❌ Branch name '$BRANCH_NAME' does not follow naming convention"
            echo ""
            echo "Branch names must match: <type>/<issue-number>/<description>"
            echo ""
            echo "Examples:"
            echo "  ✅ feature/123/add-login"
            echo "  ✅ fix/456/broken-button"
            echo "  ✅ hotfix/789/security-patch"
            echo "  ✅ docs/42/update-readme"
            echo ""
            echo "  ❌ feature/add-login (missing issue number)"
            echo "  ❌ feature/v1.0.0/add-login (use issue number, not version)"
            echo "  ❌ 123/add-login (missing type prefix)"
            exit 1
          fi

  check-pr-issue-link:
    name: PR Issue Link
    runs-on: ubuntu-latest
    steps:
      - name: Check PR description for issue link
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking PR description for issue link..."

          # Check for "Closes #123" or "Fixes #123" pattern
          if echo "$PR_BODY" | grep -qiE "(closes|fixes|resolves)\s+#[0-9]+"; then
            ISSUE_REF=$(echo "$PR_BODY" | grep -oiE "(closes|fixes|resolves)\s+#[0-9]+" | head -1)
            echo "✅ PR links to issue: $ISSUE_REF"
          else
            echo "❌ PR description must link to a GitHub issue"
            echo ""
            echo "Add one of these to your PR description:"
            echo "  Closes #123"
            echo "  Fixes #123"
            echo "  Resolves #123"
            echo ""
            echo "This ensures the linked issue is automatically closed when the PR merges."
            exit 1
          fi

  check-milestone:
    name: Milestone Assignment
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR has milestone
        env:
          MILESTONE: ${{ github.event.pull_request.milestone }}
        run: |
          if [ -n "$MILESTONE" ] && [ "$MILESTONE" != "null" ]; then
            echo "✅ PR assigned to milestone: ${{ github.event.pull_request.milestone.title }}"
          else
            echo "⚠️ WARNING: PR has no milestone assigned"
            echo ""
            echo "Consider assigning this PR to a release milestone (e.g., v1.2.0)"
            echo "to track which release it will ship in."
            echo ""
            echo "To assign a milestone:"
            echo "  1. Go to the PR page"
            echo "  2. Click 'Milestone' in the right sidebar"
            echo "  3. Select the target release"
            echo ""
            echo "This is a warning only - the PR can still be merged."
            # Warning only, don't fail
          fi

  check-pr-size:
    name: PR Size
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          BASE="${{ github.base_ref }}"
          HEAD="${{ github.head_ref }}"

          # Get lines changed (additions + deletions)
          STATS=$(git diff --shortstat origin/$BASE...HEAD)
          echo "Change stats: $STATS"

          # Extract insertions and deletions
          INSERTIONS=$(echo "$STATS" | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
          DELETIONS=$(echo "$STATS" | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")

          TOTAL=$((INSERTIONS + DELETIONS))
          echo "Total lines changed: $TOTAL"

          if [ "$TOTAL" -gt 500 ]; then
            echo ""
            echo "⚠️ WARNING: This PR has $TOTAL lines changed (recommended: ~200-300)"
            echo ""
            echo "Consider breaking this into smaller PRs for easier review."
            echo "Large PRs are harder to review and more likely to introduce bugs."
            # Warning only, don't fail
          else
            echo "✅ PR size is good: $TOTAL lines changed"
          fi

  check-changeset:
    name: Changeset Required
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changeset
        run: |
          BASE="${{ github.base_ref }}"

          # Check if a changeset file was added
          CHANGESET_FILES=$(git diff --name-only origin/$BASE...HEAD | grep "^\.changeset/.*\.md$" | grep -v "README.md" || true)

          if [ -n "$CHANGESET_FILES" ]; then
            echo "✅ Changeset found:"
            echo "$CHANGESET_FILES"
            exit 0
          fi

          # Check if this is a docs-only, config-only, or chore change that doesn't need a changeset
          CHANGED_FILES=$(git diff --name-only origin/$BASE...HEAD)

          # Files/patterns that don't require changesets
          SKIP_PATTERNS="^\.github/|^docs/|^\..*|^README\.md$|^CONTRIBUTING\.md$|^LICENSE$"

          NEEDS_CHANGESET=false
          while IFS= read -r file; do
            if [ -n "$file" ] && ! echo "$file" | grep -qE "$SKIP_PATTERNS"; then
              NEEDS_CHANGESET=true
              echo "File requires changeset: $file"
            fi
          done <<< "$CHANGED_FILES"

          if [ "$NEEDS_CHANGESET" = true ]; then
            echo ""
            echo "❌ No changeset found"
            echo ""
            echo "This PR includes code changes that require a changeset."
            echo ""
            echo "To add a changeset, run:"
            echo "  npx changeset"
            echo ""
            echo "Then select the version bump type (patch/minor/major) and describe your changes."
            echo "Commit the generated .changeset/*.md file with your PR."
            echo ""
            echo "See CONTRIBUTING.md for more details on the release process."
            exit 1
          else
            echo "✅ No changeset needed for docs/config changes only"
          fi
